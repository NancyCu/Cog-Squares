<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Bowl Squares (SEA vs NE)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05010f;
            --card: #140029;
            --text: #d9f7ff;
            --accent: #00e7ff;
            --highlight: #ff2a9f;
            --gold: #f6ff00;
            --card-border: #7b2cff;
            --neon-shadow: 0 0 16px rgba(0, 231, 255, 0.45);
            --chrome: rgba(12, 4, 28, 0.88);

            /* Layout offsets used in cell sizing (documented for maintainability). */
            /* Total horizontal non-board space (padding/margins/etc.) */
            --board-horizontal-chrome: 48px;
            /* Horizontal gap between board and surrounding content */
            --board-horizontal-gap: 20px;
            /* Extra horizontal safety margin (e.g., scrollbar/reserved space) */
            --board-horizontal-reserve: 28px;
            /* Vertical space taken by scoreboard/banner and surrounding chrome */
            --vertical-chrome-height: 240px;
            /* Gap between grid cells */
            --grid-gap: 4px;
            /* Grid dimensions (11x11 grid has 10 gaps between columns/rows) */
            --grid-cols: 11;
            --grid-col-gaps: 10;

            --cell-size: min(
                calc(
                    (100vw - var(--board-horizontal-chrome) - var(--board-horizontal-gap) - var(--board-horizontal-reserve))
                    / 11.66
                ),
                max(1px, calc((100dvh - var(--vertical-chrome-height) - (var(--grid-col-gaps) * var(--grid-gap))) / var(--grid-cols))),
                78px
            );
            --axis-size: max(28px, calc(var(--cell-size) * 0.66));
        }

        * { box-sizing: border-box; }

        body {
            background:
                radial-gradient(circle at top, rgba(123, 44, 255, 0.33), transparent 40%),
                radial-gradient(circle at bottom, rgba(0, 231, 255, 0.2), transparent 45%),
                linear-gradient(135deg, #04000a, #0a0320 60%, #090116);
            color: var(--text);
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100dvh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* --- Scoreboard --- */
        .scoreboard {
            background: linear-gradient(145deg, rgba(22, 0, 46, 0.9), var(--chrome));
            padding: 10px 12px;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border: 1px solid var(--card-border);
            box-shadow: var(--neon-shadow);
        }
        .team { text-align: center; width: 30%; }
        .team img { width: 40px; height: 40px; object-fit: contain; }
        .score {
            font-size: clamp(1.5rem, 5vw, 2.3rem);
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 12px rgba(0, 231, 255, 0.6);
        }
        .meta { text-align: center; color: #a5b4fc; font-size: 0.72rem; display: flex; flex-direction: column; gap: 5px;}
        .live-badge { background: var(--highlight); color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; display: none; }

        /* --- Banner --- */
        .winner-banner {
            background: linear-gradient(95deg, #34d399, #0ea5e9);
            color: #081a1d;
            padding: 8px;
            width: 100%;
            max-width: 800px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 8px;
            display: none;
            box-shadow: 0 0 14px rgba(52, 211, 153, 0.6);
        }

        /* --- Grid Wrapper (The Mobile Fix) --- */
        .grid-wrapper {
            width: 100%;
            max-width: 100%;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .grid-container {
            display: grid;
            grid-template-columns: var(--axis-size) repeat(10, var(--cell-size));
            grid-auto-rows: var(--cell-size);
            gap: var(--grid-gap);
        }

        /* --- Header & Inputs (Fixing White Bars) --- */
        .header-cell {
            background: var(--card);
            color: var(--accent);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            height: var(--cell-size);
            border-radius: 8px;
            position: relative;
            border: 2px solid rgba(0, 231, 255, 0.6);
            box-shadow:
                inset 0 0 10px rgba(0, 231, 255, 0.2),
                0 0 6px rgba(0, 231, 255, 0.2);
        }

        /* CRITICAL FIX: Make grid inputs transparent - scoped to grid only */
        .grid-container input {
            background-color: transparent !important;
            border: none;
            color: inherit !important;
            width: 100%;
            height: 100%;
            text-align: center;
            font-size: clamp(0.9rem, 2.6vw, 1.15rem);
            font-weight: 700;
            padding: 0;
            margin: 0;
            -webkit-appearance: none; /* Removes default iOS styling */
        }

        /* Accessibility: Focus indication for keyboard navigation */
        .grid-container input:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
        }

        /* --- Squares --- */
        .square {
            background: rgba(40, 16, 75, 0.72);
            height: var(--cell-size);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 2px solid rgba(123, 44, 255, 0.7);
            box-shadow:
                inset 0 0 12px rgba(0, 0, 0, 0.35),
                0 0 8px rgba(123, 44, 255, 0.2);
            -webkit-backdrop-filter: blur(8px) saturate(140%);
            backdrop-filter: blur(8px) saturate(140%);
        }
        .square input {
            color: #f5f3ff !important;
            font-size: clamp(0.62rem, 1.8vw, 0.9rem);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: clip;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .square.name-cell {
            background: linear-gradient(135deg, var(--name-glass) 10%, rgba(12, 3, 28, 0.6) 100%);
            border: 2px solid var(--name-border);
            box-shadow:
                0 0 16px var(--name-glow),
                inset 0 0 14px rgba(10, 6, 24, 0.65);
        }

        .square.name-cell input {
            color: var(--name-text) !important;
            letter-spacing: 0.02em;
        }

        /* --- Highlight States --- */
        .square.winner-cell {
            background: var(--gold) !important;
            border: 2px solid white;
            z-index: 10;
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--gold);
        }
        .square.winner-cell input {
            color: black !important;
            font-weight: 900;
        }
        .winner-axis {
            background: var(--accent) !important;
            color: #140029 !important;
        }

        /* --- Labels & Controls --- */
        .corner {
            grid-column: 1; grid-row: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: clamp(0.52rem, 1.6vw, 0.75rem); color: #7dd3fc;
        }
        .labels-row {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            color: #c4b5fd;
            font-size: 0.78rem;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .controls { margin-top: 10px; }
        button {
            background: linear-gradient(90deg, #00e7ff22, #ff2a9f22);
            border: 1px solid #00e7ff;
            color: #d9f7ff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media (max-width: 520px) {
            .team img { width: 30px; height: 30px; }
            #team1-name,
            #team2-name { font-size: 0.72rem; }
            .scoreboard { margin-bottom: 8px; }
            .labels-row { font-size: 0.68rem; }
            .controls { margin-top: 6px; }
        }
    </style>
</head>
<body>

    <!-- Scoreboard Section -->
    <div class="scoreboard">
        <div class="team">
            <img id="team1-logo" src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA=" alt="">
            <div id="team1-name">AWAY</div>
        </div>
        <div class="score-container">
            <div style="display: flex; gap: 20px; align-items: center;">
                <div id="team1-score" class="score">0</div>
                <div class="meta">
                    <div id="clock">Loading...</div>
                    <span id="live-indicator" class="live-badge">LIVE</span>
                </div>
                <div id="team2-score" class="score">0</div>
            </div>
        </div>
        <div class="team">
            <img id="team2-logo" src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA=" alt="">
            <div id="team2-name">HOME</div>
        </div>
    </div>

    <div id="winner-banner" class="winner-banner" role="status">
        Waiting for Score...
    </div>
    <script>
        (function () {
            var banner = document.getElementById('winner-banner');
            if (!banner || typeof MutationObserver === 'undefined') {
                return;
            }

            var observer = new MutationObserver(function (mutations) {
                for (var i = 0; i < mutations.length; i++) {
                    var mutation = mutations[i];
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (banner.style.display === 'none') {
                            // Keep the live region rendered so screen readers announce updates.
                            banner.style.display = '';
                        }
                    }
                }
            });

            observer.observe(banner, {
                attributes: true,
                attributeFilter: ['style']
            });
        })();
    </script>
    <!-- The Grid -->
    <div class="labels-row">
        <span>LEFT: <span id="away-team-label">AWAY</span></span>
        <span>TOP: <span id="home-team-label">HOME</span></span>
    </div>

    <div class="grid-wrapper">
        <div class="grid-container" id="grid">
            <!-- Javascript will build the grid here -->
        </div>
    </div>

    <div class="controls">
        <button onclick="refreshScore()">Refresh Score</button>
        <button id="btn-edit" onclick="toggleEditMode()">‚úèÔ∏è Edit Mode</button>
        <button id="btn-export" onclick="exportData()" style="display:none; background-color: #22c55e; border-color: #fff;">üíæ Copy Data for GitHub</button>
        <div id="game-setup-panel" style="display:none; margin-top: 15px; padding: 10px; background: #334155; border-radius: 8px;">
            <h4 style="margin: 0 0 10px 0; color: #cbd5e1;">Select a Game</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <select id="league-select" onchange="fetchSchedule()" style="padding: 8px; border-radius: 4px;">
                    <option value="nba">NBA</option>
                    <option value="mens-college-basketball">NCAA Men's</option>
                    <option value="nfl">NFL</option>
                </select>
                <select id="game-select" style="padding: 8px; border-radius: 4px; flex-grow: 1;">
                    <option value="">-- Select League First --</option>
                </select>
                <button onclick="applyGameSelection()" style="background: #22c55e; border: none;">Load Game</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const STORAGE_KEY = 'cog-squares-board-state-v1';

        // --- HARDCODED DATA ---
        // Top Axis (Patriots / NE): 8, 5, 6, 3, 2, 1, 7, 4, 9, 0
        let topAxis = ['8', '5', '6', '3', '2', '1', '7', '4', '9', '0'];

        // Left Axis (Seahawks / SEA): 8, 2, 5, 6, 3, 1, 9, 7, 4, 0
        let leftAxis = ['8', '2', '5', '6', '3', '1', '9', '7', '4', '0'];

        // Grid Data (Mapped exactly from your list)
        // Format: 'row-col': 'Name'
        let gridState = {
            // Row 0 (Left: 8)
            '0-0': 'üçÅ', '0-1': 'EZ', '0-2': 'SR', '0-3': 'MN', '0-4': 'LN', '0-5': 'HN', '0-6': 'Cyn', '0-7': 'SAU', '0-8': 'EM', '0-9': 'Cyn',

            // Row 1 (Left: 2)
            '1-0': 'Brian B', '1-1': 'Cyn', '1-2': 'Eli', '1-3': 'EZ', '1-4': 'MN', '1-5': 'EZ', '1-6': 'üçÅ', '1-7': 'SR', '1-8': 'MN', '1-9': 'Jamin',

            // Row 2 (Left: 5)
            '2-0': 'LN', '2-1': 'ZAN', '2-2': 'Eli', '2-3': 'üçÅ', '2-4': 'Eli', '2-5': 'MN', '2-6': 'Brian B', '2-7': 'EZ', '2-8': 'HN', '2-9': 'LN',

            // Row 3 (Left: 6)
            '3-0': 'EZ', '3-1': 'SR', '3-2': 'HN', '3-3': 'Brian B', '3-4': 'Cyn', '3-5': 'EZ', '3-6': 'ZAN', '3-7': 'LN', '3-8': 'SR', '3-9': 'üçÅ',

            // Row 4 (Left: 3)
            '4-0': 'MN', '4-1': 'Eli', '4-2': 'SAU', '4-3': 'EM', '4-4': 'MN', '4-5': 'CuViET', '4-6': 'LN', '4-7': 'Gr', '4-8': 'Eli', '4-9': 'ZAN',

            // Row 5 (Left: 1)
            '5-0': 'HN', '5-1': 'EZ', '5-2': 'HN', '5-3': 'EZ', '5-4': 'SR', '5-5': 'MN', '5-6': 'Eli', '5-7': 'üçÅ', '5-8': 'SAU', '5-9': 'MN',

            // Row 6 (Left: 9)
            '6-0': 'ZAN', '6-1': 'LN', '6-2': 'LN', '6-3': 'SR', '6-4': 'üçÅ', '6-5': 'EM', '6-6': 'Jamin', '6-7': 'SR', '6-8': 'Cyn', '6-9': 'Eli',

            // Row 7 (Left: 7)
            '7-0': 'SAU', '7-1': 'EZ', '7-2': 'Eli', '7-3': 'Brian B', '7-4': 'LN', '7-5': 'Brian B', '7-6': 'EM', '7-7': 'üçÅ', '7-8': 'LN', '7-9': 'Jev',

            // Row 8 (Left: 4)
            '8-0': 'SR', '8-1': 'EM', '8-2': 'MN', '8-3': 'Cyn', '8-4': 'SR', '8-5': 'EZ', '8-6': 'Jamin', '8-7': 'MN', '8-8': 'Cyn', '8-9': 'LN',

            // Row 9 (Left: 0)
            '9-0': 'Cyn', '9-1': 'üçÅ', '9-2': 'SAU', '9-3': 'Cyn', '9-4': 'üçÅ', '9-5': 'Eli', '9-6': 'SR', '9-7': 'ZAN', '9-8': 'Eli', '9-9': 'üçÅ'
        };

        // --- GAME CONFIGURATION ---
        let selectedLeague = 'nfl'; // Default
        let targetGameId = null;    // If null, defaults to first game found

        let isEditMode = false;
        let currentScore = { home: 0, away: 0 };
        const namePalette = {
            'SR': { glass: 'rgba(0, 242, 255, 0.26)', border: 'rgba(74, 252, 255, 0.7)', glow: 'rgba(0, 225, 255, 0.45)', text: '#eaffff' },
            'EZ': { glass: 'rgba(255, 78, 205, 0.24)', border: 'rgba(255, 139, 230, 0.7)', glow: 'rgba(255, 78, 205, 0.45)', text: '#fff0fb' },
            'MN': { glass: 'rgba(111, 255, 180, 0.22)', border: 'rgba(144, 255, 201, 0.7)', glow: 'rgba(111, 255, 180, 0.42)', text: '#f0fffa' },
            'LN': { glass: 'rgba(140, 132, 255, 0.24)', border: 'rgba(181, 174, 255, 0.7)', glow: 'rgba(140, 132, 255, 0.45)', text: '#f5f3ff' },
            'HN': { glass: 'rgba(255, 179, 71, 0.23)', border: 'rgba(255, 207, 128, 0.72)', glow: 'rgba(255, 179, 71, 0.45)', text: '#fff7ed' },
            'Cyn': { glass: 'rgba(56, 248, 255, 0.22)', border: 'rgba(132, 252, 255, 0.72)', glow: 'rgba(56, 248, 255, 0.45)', text: '#e9fdff' },
            'SAU': { glass: 'rgba(255, 109, 98, 0.22)', border: 'rgba(255, 160, 151, 0.7)', glow: 'rgba(255, 109, 98, 0.45)', text: '#fff1f1' },
            'EM': { glass: 'rgba(180, 133, 255, 0.22)', border: 'rgba(207, 178, 255, 0.7)', glow: 'rgba(180, 133, 255, 0.45)', text: '#f7f3ff' },
            'Brian B': { glass: 'rgba(91, 255, 244, 0.2)', border: 'rgba(150, 255, 247, 0.7)', glow: 'rgba(91, 255, 244, 0.42)', text: '#effffe' },
            'Eli': { glass: 'rgba(255, 215, 102, 0.22)', border: 'rgba(255, 233, 170, 0.7)', glow: 'rgba(255, 215, 102, 0.45)', text: '#fff9e6' },
            'Jamin': { glass: 'rgba(98, 168, 255, 0.22)', border: 'rgba(144, 198, 255, 0.72)', glow: 'rgba(98, 168, 255, 0.45)', text: '#eef6ff' },
            'ZAN': { glass: 'rgba(255, 115, 220, 0.22)', border: 'rgba(255, 168, 236, 0.7)', glow: 'rgba(255, 115, 220, 0.45)', text: '#fff0fa' },
            'CuViET': { glass: 'rgba(115, 255, 176, 0.2)', border: 'rgba(168, 255, 212, 0.7)', glow: 'rgba(115, 255, 176, 0.42)', text: '#effff7' },
            'Gr': { glass: 'rgba(108, 255, 200, 0.2)', border: 'rgba(164, 255, 223, 0.7)', glow: 'rgba(108, 255, 200, 0.42)', text: '#edfffa' },
            'Jev': { glass: 'rgba(255, 130, 92, 0.22)', border: 'rgba(255, 178, 152, 0.7)', glow: 'rgba(255, 130, 92, 0.45)', text: '#fff2ed' },
            'üçÅ': { glass: 'rgba(255, 96, 0, 0.22)', border: 'rgba(255, 162, 96, 0.7)', glow: 'rgba(255, 96, 0, 0.45)', text: '#fff4e6' }
        };

        function hashName(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = (hash << 5) - hash + name.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        function getNameStyle(name) {
            if (namePalette[name]) {
                return namePalette[name];
            }
            const hash = hashName(name);
            const hue = hash % 360;
            return {
                glass: `hsla(${hue}, 90%, 65%, 0.22)`,
                border: `hsla(${hue}, 95%, 75%, 0.7)`,
                glow: `hsla(${hue}, 95%, 65%, 0.45)`,
                text: '#f8fafc'
            };
        }

        function fitTextToCell(input, name) {
            if (!name) {
                return;
            }

            const rootStyles = getComputedStyle(document.documentElement);
            const cellSizeValue = parseFloat(rootStyles.getPropertyValue('--cell-size')) || 60;
            let maxFontSize = cellSizeValue * 0.32;
            let minFontSize = Math.max(8, cellSizeValue * 0.18);
            if (minFontSize > maxFontSize) {
                minFontSize = maxFontSize;
            }
            const targetWidth = cellSizeValue - 10;

            const canvas = fitTextToCell.canvas || (fitTextToCell.canvas = document.createElement('canvas'));
            const context = canvas.getContext('2d');
            if (!context) {
                // Fall back to existing CSS font-size if canvas context is unavailable
                input.style.removeProperty('font-size');
                input.style.removeProperty('font-size');
                return;
            }

            const inputStyles = getComputedStyle(input);
            const fontFamily = inputStyles.fontFamily || 'Inter, sans-serif';
            const fontWeight = inputStyles.fontWeight || '600';
            const letterSpacingValue = inputStyles.letterSpacing || 'normal';

            // Derive letter-spacing ratio from computed values for proper scaling
            let letterSpacingRatio = 0;
            let fixedLetterSpacingPx = 0;
            if (letterSpacingValue !== 'normal') {
                const computedFontSize = parseFloat(inputStyles.fontSize) || maxFontSize;
                if (letterSpacingValue.endsWith('px')) {
                    // Fixed px spacing doesn't scale with font size
                    fixedLetterSpacingPx = parseFloat(letterSpacingValue) || 0;
                } else if (letterSpacingValue.endsWith('em')) {
                    // Explicit em value - use it directly
                    letterSpacingRatio = parseFloat(letterSpacingValue) || 0;
                } else {
                    // Browser resolved to px - derive the em ratio
                    const computedPx = parseFloat(letterSpacingValue) || 0;
                    letterSpacingRatio = computedPx / computedFontSize;
                }
            }

            const nameLength = Array.from(name).length;

            let fontSize = maxFontSize;
            while (fontSize > minFontSize) {
                context.font = `${fontWeight} ${fontSize}px ${fontFamily}`;

                const letterSpacingPx = fixedLetterSpacingPx || (letterSpacingRatio * fontSize);

                const textWidth = context.measureText(name).width;
                const spacingWidth = letterSpacingPx * Math.max(0, nameLength - 1);
                const totalWidth = textWidth + spacingWidth;

                if (totalWidth <= targetWidth) {
                    break;
                }
                fontSize -= 0.5;
            }

            input.style.fontSize = `${fontSize}px`;
        }

        function adjustNameFonts() {
            document.querySelectorAll('.square input').forEach((input) => {
                const name = input.value.trim();
                if (name) {
                    fitTextToCell(input, name);
                }
            });
        }

        let adjustNameFontsRafId = null;

        // --- INIT ---
        function init() {
            loadSavedData();
            buildGrid();
            initializeGameSelector();
            fetchScores();
            setInterval(fetchScores, 15000); // 15s polling
            window.addEventListener('resize', () => {
                if (adjustNameFontsRafId !== null) {
                    return;
                }
                adjustNameFontsRafId = window.requestAnimationFrame(() => {
                    adjustNameFontsRafId = null;
                    adjustNameFonts();
                });
            });
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const inputs = document.querySelectorAll('#grid input');
            const btnEdit = document.getElementById('btn-edit');
            const btnExport = document.getElementById('btn-export');
            const panel = document.getElementById('game-setup-panel');

            inputs.forEach(input => {
                input.readOnly = !isEditMode;
                input.style.cursor = isEditMode ? 'text' : 'default';
                input.style.border = isEditMode ? '1px dashed #60a5fa' : 'none';
            });

            if (isEditMode) {
                btnEdit.innerText = "‚ùå Stop Editing";
                btnEdit.style.background = "#ef4444";
                btnExport.style.display = "inline-block";
                panel.style.display = 'block';
                fetchSchedule();
            } else {
                // Sync in-memory variables from DOM when leaving edit mode
                syncDataFromDOM();
                btnEdit.innerText = "‚úèÔ∏è Edit Mode";
                btnEdit.style.background = ""; // Reset to default
                btnExport.style.display = "none";
                panel.style.display = 'none';
            }
        }

        function initializeGameSelector() {
            const leagueSelect = document.getElementById('league-select');
            const gameSelect = document.getElementById('game-select');
            leagueSelect.value = selectedLeague;
            gameSelect.innerHTML = '<option value="">-- Select a Game --</option>';
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;

                const parsed = JSON.parse(saved);
                if (Array.isArray(parsed.topAxis) && parsed.topAxis.length === 10) {
                    topAxis = parsed.topAxis.map((value) => String(value ?? ''));
                }
                if (Array.isArray(parsed.leftAxis) && parsed.leftAxis.length === 10) {
                    leftAxis = parsed.leftAxis.map((value) => String(value ?? ''));
                }
                if (parsed.gridState && typeof parsed.gridState === 'object') {
                    const loadedGrid = {};
                    Object.keys(parsed.gridState).forEach((key) => {
                        loadedGrid[key] = String(parsed.gridState[key] ?? '');
                    });
                    gridState = loadedGrid;
                }
                if (typeof parsed.selectedLeague === 'string' && parsed.selectedLeague.length > 0) {
                    selectedLeague = parsed.selectedLeague;
                }
                if (typeof parsed.targetGameId === 'string' && parsed.targetGameId.length > 0) {
                    targetGameId = parsed.targetGameId;
                }
            } catch (error) {
                console.warn('Unable to load saved board data.', error);
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    topAxis,
                    leftAxis,
                    gridState,
                    selectedLeague,
                    targetGameId
                }));
            } catch (error) {
                console.warn('Unable to save board data.', error);
            }
        }

        function saveDataFromDOM() {
            for (let i = 0; i < 10; i++) {
                topAxis[i] = document.querySelector(`#top-${i} input`).value;
                leftAxis[i] = document.querySelector(`#left-${i} input`).value;
            }

            gridState = {};
            for (let r = 0; r < 10; r++) {
                for (let c = 0; c < 10; c++) {
                    const val = document.querySelector(`#sq-${r}-${c} input`).value;
                    if (val) gridState[`${r}-${c}`] = val;
                }
            }

            saveData();
        }

        function syncDataFromDOM() {
            saveDataFromDOM();

            // Re-highlight winners with updated data
            highlightWinners();
        }

        function refreshScore() {
            if (isEditMode) {
                saveDataFromDOM();
            }
            window.location.reload();
        }

        function exportData() {
            // 1. Scrape Top Axis
            let newTop = [];
            for (let i = 0; i < 10; i++) {
                newTop.push(document.querySelector(`#top-${i} input`).value);
            }

            // 2. Scrape Left Axis
            let newLeft = [];
            for (let i = 0; i < 10; i++) {
                newLeft.push(document.querySelector(`#left-${i} input`).value);
            }

            // 3. Scrape Grid
            let newGrid = {};
            for (let r = 0; r < 10; r++) {
                for (let c = 0; c < 10; c++) {
                    const val = document.querySelector(`#sq-${r}-${c} input`).value;
                    if (val) newGrid[`${r}-${c}`] = val;
                }
            }

            // 4. Escape <\/script> in all strings to prevent script injection
            const escapeScriptTag = (str) => str.replace(/<\/script>/gi, '<\\/script>');
            newTop = newTop.map(escapeScriptTag);
            newLeft = newLeft.map(escapeScriptTag);
            const escapedGrid = {};
            for (const key in newGrid) {
                escapedGrid[key] = escapeScriptTag(newGrid[key]);
            }

            // 5. Generate the Code String
            const codeBlock = `
// --- PASTE THIS OVER YOUR EXISTING DATA SECTION ---
let selectedLeague = ${JSON.stringify(selectedLeague)};
let targetGameId = ${JSON.stringify(targetGameId)};
let topAxis = ${JSON.stringify(newTop)};
let leftAxis = ${JSON.stringify(newLeft)};
let gridState = ${JSON.stringify(escapedGrid, null, 4)};
`;

            // 6. Copy to Clipboard & Alert
            navigator.clipboard.writeText(codeBlock).then(() => {
                alert("DATA COPIED TO CLIPBOARD!\\n\\n1. Go to index.html in GitHub.\\n2. Find the 'HARDCODED DATA' section.\\n3. Paste this code over it.\\n4. Commit changes.");
            }).catch(err => {
                console.error('Failed to copy', err);
                alert("Could not copy automatically. Check console for data.");
                console.log(codeBlock);
            });
        }

        function buildGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            // 1. Top Left Corner
            const corner = document.createElement('div');
            corner.className = 'corner';
            corner.innerText = "SEA \\ NE";
            grid.appendChild(corner);

            // 2. Top Axis
            for (let i = 0; i < 10; i++) {
                const cell = document.createElement('div');
                cell.className = 'header-cell';
                cell.id = `top-${i}`;
                const input = document.createElement('input');
                input.className = 'header-input';
                input.value = topAxis[i]; // Read only
                input.readOnly = true;
                input.addEventListener('input', () => {
                    if (isEditMode) {
                        saveDataFromDOM();
                    }
                });
                cell.appendChild(input);
                grid.appendChild(cell);
            }

            // 3. Rows
            for (let row = 0; row < 10; row++) {
                // Left Axis Cell
                const leftCell = document.createElement('div');
                leftCell.className = 'header-cell';
                leftCell.id = `left-${row}`;
                const leftInput = document.createElement('input');
                leftInput.className = 'header-input';
                leftInput.value = leftAxis[row]; // Read only
                leftInput.readOnly = true;
                leftInput.addEventListener('input', () => {
                    if (isEditMode) {
                        saveDataFromDOM();
                    }
                });
                leftCell.appendChild(leftInput);
                grid.appendChild(leftCell);

                // 10 Squares
                for (let col = 0; col < 10; col++) {
                    const square = document.createElement('div');
                    square.className = 'square';
                    square.id = `sq-${row}-${col}`;

                    const input = document.createElement('input');
                    const name = gridState[`${row}-${col}`] || '';
                    input.value = name;
                    input.readOnly = true;
                    input.addEventListener('input', () => {
                        const nextName = input.value.trim();
                        if (nextName) {
                            const style = getNameStyle(nextName);
                            square.classList.add('name-cell');
                            square.style.setProperty('--name-glass', style.glass);
                            square.style.setProperty('--name-border', style.border);
                            square.style.setProperty('--name-glow', style.glow);
                            square.style.setProperty('--name-text', style.text);
                        } else {
                            square.classList.remove('name-cell');
                            square.style.removeProperty('--name-glass');
                            square.style.removeProperty('--name-border');
                            square.style.removeProperty('--name-glow');
                            square.style.removeProperty('--name-text');
                        }
                        fitTextToCell(input, nextName);
                        if (isEditMode) {
                            saveDataFromDOM();
                        }
                    });

                    square.appendChild(input);
                    if (name) {
                        const style = getNameStyle(name);
                        square.classList.add('name-cell');
                        square.style.setProperty('--name-glass', style.glass);
                        square.style.setProperty('--name-border', style.border);
                        square.style.setProperty('--name-glow', style.glow);
                        square.style.setProperty('--name-text', style.text);
                    }
                    grid.appendChild(square);
                }
            }

            adjustNameFonts();
        }

        window.addEventListener('beforeunload', () => {
            if (isEditMode) {
                saveDataFromDOM();
            }
        });

        // --- API LOGIC ---
        async function fetchSchedule() {
            const league = document.getElementById('league-select').value;
            const select = document.getElementById('game-select');

            select.innerHTML = '<option>Loading schedule...</option>';
            select.disabled = true;

            try {
                // 1. Calculate Date Range (Today + Tomorrow)
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1); // Fetch Today + Tomorrow

                // Format to YYYYMMDD
                const formatDate = (date) => {
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${yyyy}${mm}${dd}`;
                };

                const dateStr = formatDate(today) + '-' + formatDate(tomorrow);

                // 2. Construct Base URL
                let baseUrl = `https://site.api.espn.com/apis/site/v2/sports/basketball/${league}/scoreboard`;
                if (league === 'nfl') {
                    baseUrl = "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard";
                }

                // 3. Append Date Parameter
                const fetchUrl = `${baseUrl}?dates=${dateStr}`;

                // 4. Fetch Data
                const res = await fetch(fetchUrl);
                const data = await res.json();

                // 5. Populate Dropdown
                select.innerHTML = '';

                if (!data.events || data.events.length === 0) {
                    select.innerHTML = '<option>No games found for dates ' + dateStr + '</option>';
                } else {
                    // Add a default prompt
                    const defaultOpt = document.createElement('option');
                    defaultOpt.text = "-- Select a Game --";
                    defaultOpt.value = "";
                    select.appendChild(defaultOpt);

                    data.events.forEach(event => {
                        const name = event.name;
                        const dateObj = new Date(event.date);

                        // Format: "Feb 9 - 7:30 PM"
                        const day = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        const time = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                        const option = document.createElement('option');
                        option.value = event.id;
                        option.text = `${name} (${day} ${time})`;
                        select.appendChild(option);
                    });
                }
                select.disabled = false;

            } catch (e) {
                console.error("Schedule Fetch Error:", e);
                select.innerHTML = '<option>Error loading schedule. Check Console.</option>';
                select.disabled = false;
            }
        }

        function applyGameSelection() {
            selectedLeague = document.getElementById('league-select').value;
            targetGameId = document.getElementById('game-select').value || null;
            saveData();
            fetchScores();
            alert("Game Updated! Don't forget to Export Data to save this change.");
        }

        async function fetchScores() {
            try {
                // 1. Calculate Date Range (Match the Schedule logic)
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 2); // Look ahead 48 hours

                const formatDate = (date) => {
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${yyyy}${mm}${dd}`;
                };
                const dateStr = formatDate(today) + '-' + formatDate(tomorrow);

                // 2. Determine Base URL based on selected league
                let baseUrl = "";
                if (selectedLeague === 'nfl') {
                    baseUrl = "https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard";
                } else {
                    // Handles 'nba' or 'mens-college-basketball'
                    baseUrl = `https://site.api.espn.com/apis/site/v2/sports/basketball/${selectedLeague}/scoreboard`;
                }

                // 3. Append the Date Range to the URL
                const url = `${baseUrl}?dates=${dateStr}`;

                // 4. Fetch Data
                const res = await fetch(url);
                const data = await res.json();

                // 5. Find the specific selected game
                let game = null;
                if (targetGameId) {
                    // Try to find the game ID the user selected
                    game = data.events.find(e => e.id === targetGameId);
                }

                // Fallback: If no ID set (or not found), use the first one in the list
                if (!game) {
                    game = data.events[0];
                }

                // --- EXISTING SCORE PARSING LOGIC BELOW ---
                if (game) {
                    const comp = game.competitions[0];
                    const home = comp.competitors.find(c => c.homeAway === 'home');
                    const away = comp.competitors.find(c => c.homeAway === 'away');

                    // Update Names/Logos
                    document.getElementById('team1-name').innerText = away.team.abbreviation;
                    document.getElementById('team2-name').innerText = home.team.abbreviation;

                    // Check for 'name' vs 'shortDisplayName' to prevent undefined errors
                    document.getElementById('away-team-label').innerText = away.team.name || away.team.shortDisplayName;
                    document.getElementById('home-team-label').innerText = home.team.name || home.team.shortDisplayName;

                    document.getElementById('team1-logo').src = away.team.logo;
                    document.getElementById('team2-logo').src = home.team.logo;

                    // Update Scores
                    document.getElementById('team1-score').innerText = away.score;
                    document.getElementById('team2-score').innerText = home.score;

                    // Update Clock/Status
                    document.getElementById('clock').innerText = game.status.type.detail;
                    if(game.status.type.state === 'in') {
                        document.getElementById('live-indicator').style.display = 'inline-block';
                    } else {
                        document.getElementById('live-indicator').style.display = 'none';
                    }

                    // Update Logic Variables
                    currentScore.away = parseInt(away.score) || 0;
                    currentScore.home = parseInt(home.score) || 0;

                    // --- HISTORY LOGGING ---
                    if (typeof lastLogScore !== 'undefined') {
                        if (currentScore.home !== lastLogScore.home || currentScore.away !== lastLogScore.away) {
                            // Calculate winner
                            const winner = getWinnerNameForScore(currentScore.home, currentScore.away);
                            const timeLabel = game.status.type.detail;

                            const item = document.createElement('div');
                            item.className = 'history-item';
                            item.innerHTML = `
                                <div class="history-info">
                                    <div class="history-score">${away.team.abbreviation} ${currentScore.away} - ${currentScore.home} ${home.team.abbreviation}</div>
                                    <div class="history-time">${timeLabel}</div>
                                </div>
                                <div class="history-winner">${winner}</div>
                            `;
                            const list = document.getElementById('history-list');
                            if(list) list.insertBefore(item, list.firstChild);

                            lastLogScore = { home: currentScore.home, away: currentScore.away };
                        }
                    }

                    highlightWinners();
                }

            } catch (e) {
                console.error("Score fetch error", e);
                document.getElementById('clock').innerText = "Loading...";
            }
        }


        // --- HIGHLIGHT WINNER LOGIC ---
        function highlightWinners() {
            document.querySelectorAll('.winner-cell').forEach(el => el.classList.remove('winner-cell'));
            document.querySelectorAll('.winner-axis').forEach(el => el.classList.remove('winner-axis'));
            const banner = document.getElementById('winner-banner');
            banner.style.display = 'none';

            // Home (Top Axis) / Away (Left Axis)
            const lastDigitHome = currentScore.home % 10;
            const lastDigitAway = currentScore.away % 10;

            let winningColIndex = -1;
            let winningRowIndex = -1;

            for(let i=0; i<10; i++) {
                if(parseInt(topAxis[i]) === lastDigitHome) winningColIndex = i;
            }

            for(let i=0; i<10; i++) {
                if(parseInt(leftAxis[i]) === lastDigitAway) winningRowIndex = i;
            }

            if(winningColIndex !== -1 && winningRowIndex !== -1) {
                document.getElementById(`top-${winningColIndex}`).classList.add('winner-axis');
                document.getElementById(`left-${winningRowIndex}`).classList.add('winner-axis');

                const sq = document.getElementById(`sq-${winningRowIndex}-${winningColIndex}`);
                if(sq) {
                    sq.classList.add('winner-cell');

                    const winnerName = gridState[`${winningRowIndex}-${winningColIndex}`] || "Empty Square";
                    banner.innerText = "Current Winner: " + winnerName;
                    banner.style.display = 'block';
                }
            }
        }

        init();
    </script>
</body>
</html>
